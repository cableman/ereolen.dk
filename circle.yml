machine:
  environment:
    # Add composer global bin dir to path.
    PATH: $HOME/.composer/vendor/bin:$PATH
  php:
    # Fix version so we'll be using phpenv instead of the system PHP,
    # which allows us to fiddle with the conf files.
    version: 5.4.21

dependencies:
  cache_directories:
    - "~/.composer"
  pre:
    # Install Drush. We need these two lines to not install Drush dev
    # dependencies, and not update any Circle installed composer
    # libraries.
    - if [[ ! -d ~/.composer/vendor/drush/drush ]]; then composer --no-interaction --no-update global require drush/drush:6.2.0 ; fi
    - if [[ ! -d ~/.composer/vendor/drush/drush ]]; then composer --prefer-source --no-interaction global update ; fi
    - mkdir ~/.drush
    - cd ~/.drush && drush dl drush_drake
    - cd ~/.drush && drush dl coder-7.x-2.4
    - git clone git@github.com:reload/drake_ci.git ~/.drush/drake_ci
    # Install csslint.
    - npm install -g csslint
    # Install jshint.
    - npm install -g jshint
    # Hotwire sendmail so PHP will think the mails are sendt.
    - echo "sendmail_path = /bin/true" > ~/.phpenv/versions/$(phpenv global)/etc/conf.d/sendmail.ini

test:
  override:
    # Run basic tests.
    - drush --nocolor drake php-lint
    # Whoops, ting.module actually contains custom devel.module
    # support, so we can't check for debug statements.
    # - drush --nocolor drake php-debug
    - drush --nocolor drake check-js
    # Who cares anyway?
    # - drush --nocolor drake check-css
    # Run Drupal's simpletests and unittest (if any).
    #- drush --nocolor drake run-tests

deployment:
  demo:
    branch: develop
    commands:
      - drush deploy @circle-dev -y
