<?php

/**
 * @file
 * Module for making lists of content with fancy theming.
 */

/**
 * Implements hook_ctools_plugin_directory().
 */
function breol_fancy_box_ctools_plugin_directory($module, $plugin) {
  if ($module == 'ctools' && !empty($plugin)) {
    return "plugins/$plugin";
  }
}

/**
 * Implements hook_theme().
 */
function breol_fancy_box_theme($existing, $type, $theme, $path) {
  return array(
    'breol_fancy_box' => array(
      'variables' => array(
        'nodes' => array(),
      ),
      'path' => drupal_get_path('module', 'breol_fancy_box') . '/templates',
      'template' => 'fancy',
    ),
  );
}

/**
 * Implements hook_preprocess_node().
 */
function breol_fancy_box_preprocess_node(&$variables, $hook) {
  if (!empty($variables['field_color'][0]['rgb'])) {
    $rgb = _breol_fancy_box_hex2rgb($variables['field_color'][0]['rgb']);
    $variables['rgba_background'] = 'style="background:rgba(' . implode(",", $rgb) . ', 0.7);"';
  }

  $view_modes = array('teaser_small', 'teaser_medium');
  $node_types = array('link', 'breol_video', 'breol_news');

  if (in_array($variables['view_mode'], $view_modes) &&
    in_array($variables['type'], $node_types)) {

    $variables['teaser_title'] = $variables['title'];

    switch ($variables['type']) {
      case 'link':
        $summary = strip_tags(render($variables['content']['body']));
        $variables['teaser_type'] = t('link');
        $variables['teaser_caption'] = $summary;
        $variables['teaser_link'] = l(t('view more'), url($variables['field_breol_link'][0]['url']));
        break;

      case 'breol_video':
        $variables['teaser_type'] = t('video');
        $variables['teaser_caption'] = $variables['field_breol_video'][0]['filename'];
        $variables['teaser_link'] = l(t('view more'), url($variables['node_url']));
        break;

      case 'breol_news':
        $variables['teaser_type'] = t('news');
        $summary = strip_tags(render($variables['content']['body']));
        $variables['teaser_caption'] = $summary;
        $variables['teaser_link'] = l(t('view more'), url($variables['node_url']));
        break;
    }
  }
}

/**
 * Convert hex to rgb color value.
 */
function _breol_fancy_box_hex2rgb($hex) {
  $hex = str_replace("#", "", $hex);

  if (strlen($hex) == 3) {
    $r = hexdec(substr($hex, 0, 1) . substr($hex, 0, 1));
    $g = hexdec(substr($hex, 1, 1) . substr($hex, 1, 1));
    $b = hexdec(substr($hex, 2, 1) . substr($hex, 2, 1));
  }
  else {
    $r = hexdec(substr($hex, 0, 2));
    $g = hexdec(substr($hex, 2, 2));
    $b = hexdec(substr($hex, 4, 2));
  }
  $rgb = array($r, $g, $b);

  return $rgb;
}
