<?php
/**
 * @file
 * Main module implementation which defines functions used in the administration
 * interface and a few helper functions.
 */

require_once drupal_get_path('module', 'publizon') . '/includes/publizon.admin.inc';

function publizon_ding_provider() {
  $path = drupal_get_path('module', 'publizon') . '/includes';

  return array(
    'title' => 'Publizon provider',
    'settings' => 'publizon_settings_form',
    'provides' => array(
      'user' => array(
        'prefix' => 'user',
        'file' => $path - '/publizon.user.inc',
      ),
      'loan' => array(
        'prefix' => 'loan',
        'file' => $path - '/publizon.loan.inc',
      ),
      'reservation' => array(
        'prefix' => 'reservation',
        'file' => $path - '/publizon.reservation.inc',
      ),
      'availability' => array(
        'prefix' => 'availability',
        'file' => $path - '/publizon.availability.inc',
      ),
    ),
  );
}

/**
 * Helper function that extracts the name of the author(s) on a ting object.
 *
 * @param object $ting_object
 *   Ting object.
 * @param bool $link
 *   If the parameter is true the authors returned is search links else plain
 *   text.
 *
 * @return string
 *   The author(s) found and the empty string if non is found.
 */
function publizon_get_authors($ting_object, $link = TRUE) {
  $authors = '';
  if (isset($ting_object->record["dc:creator"]["dkdcplus:aut"][0])) {
    if ($link) {
      $authors = l($ting_object->record["dc:creator"]["dkdcplus:aut"][0], 'ting/search/"' . $ting_object->record["dc:creator"]["dkdcplus:aut"][0] . '"');
    }
    else {
      $authors = $ting_object->record["dc:creator"]["dkdcplus:aut"][0];
    }
  }
  else {
    // Find all authors involved.
    $contributors = array();
    if (isset($ting_object->record['dc:contributor']['dkdcplus:edt'])) {
      $contributors = array_merge($contributors, $ting_object->record['dc:contributor']['dkdcplus:edt']);
    }
    if (isset($ting_object->record['dc:contributor']['dkdcplus:aut'])) {
      $contributors = array_merge($contributors, $ting_object->record['dc:contributor']['dkdcplus:aut']);
    }

    // Loop over the authors and create the string.
    sort($contributors);
    foreach ($contributors as $contributor) {
      if ($link) {
        $authors .= l($contributor, 'ting/search/' . $contributor) . ', ';
      }
      else {
        $authors .= $authors . ', ';
      }
    }
    $authors = drupal_substr($authors, 0, -2);
  }

  return $authors;
}

/**
 * Search the T!NG data well for information based on ISBN.
 *
 * If more than one match is found only the first match is returned.
 *
 * @param string $isbn
 *   ISBN number for the product that is searched.
 *
 * @return TingObject
 *   Datawell object for the product found, if non is found FALSE will be
 *   returned.
 */
function publizon_ting_find_object($isbn) {
  // Ensure that the ting client is available.
  module_load_include('client.inc', 'ting');

  // Build ting request.
  $request = ting_get_request_factory()->getSearchRequest();
  $request = ting_add_agency($request);
  $request = ting_add_profile($request);

  // Try to fetch ting object based on ISBN number. Sadly not all object in
  // ebooks or net sound have ISBN, but uses oss:PROVIDER-ID, which we can not
  // search directly on (so no dc.identifier=*). Also therefor it have been
  // renamed, because it does not only find object by ISBN.
  $request->setQuery($isbn);
  $request->setNumResults(1);

  // Execute the fetch.
  $response = ting_execute($request);
  $object = FALSE;
  if (isset($response->collections[0]->objects[0])) {
    $object = $response->collections[0]->objects[0];
  }

  return $object;
}

/**
 * Helper function that findes all libraries stored in the Publizon configuration
 * and returns the library names indexed by retailer id.
 *
 * @staticvar array $retailers
 *   Static cache used to speed-up the search if call more than once.
 * @param bool $reset
 *   If TRUE the static cache will be rebuild. Defaults to FALSE.
 * @return array
 *   Library names indexed by retailer id.
 */
function publizon_get_libraries($reset = FALSE) {
  static $libraries;
  if (!isset($libraries) || $reset) {
    $libraries = variable_get('publizon_libraries', array());
    if (empty($libraries)) {
      // We are missing some library configuration here.
      drupal_set_message(t('You need to login as administrator and configure Publizon library lists'), 'warning', FALSE);
      return array();
    }

    // Sort the libraries by library name.
    setlocale(LC_ALL, 'da_DK.UTF8');
    asort($libraries, SORT_LOCALE_STRING);
    setlocale(LC_ALL, '');
  }

  return $libraries;
}

/**
 * Helper function that loads Publizon configuration information about a given
 * library and return the information as an array. The array contains
 * retailer_id, retailer_key_code and library_name.
 *
 * @staticvar array $libraries
 *   Static cache used to speed-up the search if call more than once.
 *
 * @param string $retailer_id
 *   Retailer id that identifies the library at Publizon.
 * @param bool $reset
 *   If TRUE the static cache will be rebuild. Defaults to FALSE.
 *
 * @return array
 *   Basic information about the library entered at the publizon administration
 *   interface.
 */
function publizon_get_library($retailer_id, $reset = FALSE) {
  static $libraries;
  if (!isset($libraries) || !isset($libraries[$retailer_id]) || $reset) {
    $libraries = variable_get('publizon_libraries', array());
    if (empty($libraries)) {
      // We are missing som library configuration here.
      drupal_set_message(t('You need to login as administrator and configure Publizon library lists'), 'warning', FALSE);
      return array();
    }
  }
  return isset($libraries[$retailer_id]) ? $libraries[$retailer_id] : array();
}
